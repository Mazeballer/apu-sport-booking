generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Users
model User {
  id        String             @id @default(uuid())
  email     String             @unique
  role      Role               @default(student)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  name      String             @default("")
  authId    String?            @unique

  bookings  Booking[]
  decisions EquipmentRequest[] @relation("Decider")
  pushSubs  PushSubscription[]
}

/// Facility Management

model Facility {
  id             String      @id @default(uuid())
  name           String
  type           String
  location       String
  locationType   String      @default("Indoor")
  description    String?
  capacity       Int         @default(0)
  openTime       String?
  closeTime      String?
  rules          String?
  photos         String[]
  active         Boolean     @default(true)
  isMultiSport   Boolean     @default(false)
  sharedSports   String[]    @default([])
  numberOfCourts Int         @default(1)
  createdAt      DateTime    @default(now())

  courts    Court[]
  bookings  Booking[]
  equipment Equipment[]
}

/// Courts

model Court {
  id         String    @id @default(uuid())
  facilityId String
  name       String
  active     Boolean   @default(true)

  facility   Facility  @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  bookings   Booking[]

  @@unique([facilityId, name])
  @@index([facilityId])
}

/// Bookings

model Booking {
  id         String        @id @default(uuid())
  userId     String
  facilityId String
  courtId    String
  start      DateTime       @db.Timestamptz(6)
  end        DateTime       @db.Timestamptz(6)
  status     BookingStatus  @default(confirmed)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  reminderEmailSentAt DateTime?


  facility   Facility       @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  court      Court          @relation(fields: [courtId], references: [id], onDelete: Cascade)
  user       User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  equipmentRequests EquipmentRequest[]

  @@index([facilityId, start])
  @@index([courtId, start])
  @@index([userId, start])
  @@index([start, status, reminderEmailSentAt])
}

/// ===========================
/// Equipment
/// ===========================
model Equipment {
  id           String   @id @default(uuid())
  facilityId   String
  name         String
  qtyTotal     Int
  qtyAvailable Int

  facility     Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  requestItems EquipmentRequestItem[]

  @@index([facilityId, name])
}

/// ===========================
/// Equipment Requests
/// ===========================
model EquipmentRequest {
  id         String         @id @default(uuid())
  bookingId  String
  status     EquipReqStatus @default(pending) // pending → approved/denied → done
  decidedBy  String?
  decidedAt  DateTime?
  note       String?
  createdAt  DateTime       @default(now())
  returnedAt DateTime?      // when everything returned or resolved

  booking    Booking        @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  decider    User?          @relation("Decider", fields: [decidedBy], references: [id])
  items      EquipmentRequestItem[]

  @@index([status, createdAt])
}

/// ===========================
/// Equipment Request Items
/// ===========================
model EquipmentRequestItem {
  id          String                 @id @default(uuid())
  requestId   String
  equipmentId String

  qty         Int
  qtyReturned Int                    @default(0)

  issuedAt    DateTime?              // used for overdue
  dismissed   Boolean                @default(false) // hide from admin status list

  condition   EquipReturnCondition?  // good, damaged, lost, not_returned
  damageNotes String?

  equipment   Equipment              @relation(fields: [equipmentId], references: [id])
  request     EquipmentRequest       @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@unique([requestId, equipmentId])
  @@index([equipmentId])
}

/// ===========================
/// Push Subscriptions
/// ===========================
model PushSubscription {
  id        String   @id @default(uuid())
  userId    String
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

/// ===========================
/// Enums
/// ===========================
enum Role {
  student
  staff
  admin
}

enum BookingStatus {
  confirmed
  cancelled
  rescheduled
}

enum EquipReqStatus {
  pending   // student requested equipment during booking
  approved  // staff approved request
  denied    // rejected by staff
  done      // all items returned/resolved
}

enum EquipReturnCondition {
  good         // fully returned
  damaged      // returned but damaged
  lost         // not returned, confirmed lost
  not_returned // overdue
}
