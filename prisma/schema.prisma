generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// ===========================
/// Core
/// ===========================
model User {
  id        String             @id @default(uuid())
  email     String             @unique
  role      Role               @default(student)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  name      String             @default("")
  authId    String?            @unique
  bookings  Booking[]
  decisions EquipmentRequest[] @relation("Decider")
  pushSubs  PushSubscription[]
}

/// ===========================
/// Facility Management
/// ===========================
model Facility {
  id             String      @id @default(uuid())
  name           String
  type           String                      // Main sport type
  location       String
  locationType   String      @default("Indoor")
  description    String?
  capacity       Int         @default(0)
  openTime       String?                     // e.g. "07:00"
  closeTime      String?                     // e.g. "22:00"
  rules          String?                     // stored as newline-separated
  photos         String[]                    // [facilityImage, layoutImage]
  active         Boolean     @default(true)
  isMultiSport   Boolean     @default(false)
  sharedSports   String[]    @default([])     // if isMultiSport = true
  numberOfCourts Int         @default(1)
  createdAt      DateTime    @default(now())

  courts    Court[]
  bookings  Booking[]
  equipment Equipment[]
}

/// ===========================
/// Spaces (Courts)
/// ===========================
model Court {
  id         String    @id @default(uuid())
  facilityId String
  name       String
  active     Boolean   @default(true)

  facility   Facility  @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  bookings   Booking[]

  @@unique([facilityId, name])
  @@index([facilityId])
}

/// ===========================
/// Bookings
/// ===========================
model Booking {
  id         String      @id @default(uuid())
  userId     String
  facilityId String
  courtId    String
  sportName  String?                     // e.g. "Basketball" or "Futsal"
  start      DateTime     @db.Timestamptz(6)
  end        DateTime     @db.Timestamptz(6)
  status     BookingStatus @default(confirmed)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  facility   Facility  @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  court      Court     @relation(fields: [courtId], references: [id], onDelete: Cascade)
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  equipmentRequests EquipmentRequest[]

  @@unique([courtId, start, end])
  @@index([facilityId, start])
  @@index([courtId, start])
  @@index([userId, start])
}

/// ===========================
/// Equipment & Requests
/// ===========================
model Equipment {
  id           String   @id @default(uuid())
  facilityId   String
  name         String
  qtyTotal     Int
  qtyAvailable Int
  notes        String?

  facility     Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  requestItems EquipmentRequestItem[]

  @@index([facilityId, name])
}

model EquipmentRequest {
  id        String                 @id @default(uuid())
  bookingId String
  status    EquipReqStatus         @default(pending)
  decidedBy String?
  decidedAt DateTime?
  note      String?
  createdAt DateTime               @default(now())

  booking   Booking                @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  decider   User?                  @relation("Decider", fields: [decidedBy], references: [id])
  items     EquipmentRequestItem[]

  @@index([status, createdAt])
}

model EquipmentRequestItem {
  id          String           @id @default(uuid())
  requestId   String
  equipmentId String
  qty         Int

  equipment   Equipment        @relation(fields: [equipmentId], references: [id])
  request     EquipmentRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@unique([requestId, equipmentId])
}

/// ===========================
/// PWA Push Subscriptions
/// ===========================
model PushSubscription {
  id        String   @id @default(uuid())
  userId    String
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

/// ===========================
/// Enums
/// ===========================
enum Role {
  student
  staff
  admin
}

enum BookingStatus {
  confirmed
  cancelled
  rescheduled
}

enum EquipReqStatus {
  pending
  approved
  denied
  issued
  returned
}
